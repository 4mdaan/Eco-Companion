<%- include('../partials/head', { pageCSS: 'carrinho' }) %>

<%- include('../partials/header', { currentPage: 'checkout' }) %>

<!-- Hero do Checkout -->
<section class="checkout-hero">
  <section class="container">
    <h1 class="checkout-title">Finalizar Compra</h1>
    <p class="checkout-subtitle">Complete seus dados para confirmar a reserva</p>
    
    <!-- Progress Steps -->
    <section class="checkout-steps">
      <section class="step completed">
        <section class="step-number">1</section>
        <section class="step-label">Carrinho</section>
      </section>
      <section class="step active">
        <section class="step-number">2</section>
        <section class="step-label">Dados</section>
      </section>
      <section class="step">
        <section class="step-number">3</section>
        <section class="step-label">Pagamento</section>
      </section>
      <section class="step">
        <section class="step-number">4</section>
        <section class="step-label">Confirma√ß√£o</section>
      </section>
    </section>
  </section>
</section>

<!-- Conte√∫do do Checkout -->
<section class="checkout-content">
  <section class="container">
    <% if (typeof req !== 'undefined' && req.query && req.query.erro) { %>
      <section class="alert alert-warning" style="background: #fef3cd; color: #856404; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; border: 1px solid #ffeaa7;">
        <% if (req.query.erro === 'dados-incompletos') { %>
          ‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios.
        <% } else { %>
          ‚ö†Ô∏è Ocorreu um erro. Tente novamente.
        <% } %>
      </section>
    <% } %>
    <form method="POST" action="/carrinho/checkout" class="checkout-form">
      <section class="checkout-grid">
        <!-- Formul√°rio de Dados -->
        <section class="checkout-dados">
          <!-- Dados Pessoais -->
          <section class="form-section">
            <h2 class="section-title">Dados Pessoais</h2>
            
            <section class="form-row">
              <section class="form-group">
                <label for="nome" class="form-label">Nome Completo *</label>
                <input type="text" id="nome" name="nome" class="form-input" required>
              </section>
            </section>
            
            <section class="form-row">
              <section class="form-group">
                <label for="email" class="form-label">E-mail *</label>
                <input type="email" id="email" name="email" class="form-input" required>
              </section>
              
              <section class="form-group">
                <label for="telefone" class="form-label">Telefone *</label>
                <input type="tel" id="telefone" name="telefone" class="form-input" required>
              </section>
            </section>
            
            <section class="form-row">
              <section class="form-group">
                <label for="cpf" class="form-label">CPF *</label>
                <input type="text" id="cpf" name="cpf" class="form-input" required>
              </section>
              
              <section class="form-group">
                <label for="nascimento" class="form-label">Data de Nascimento</label>
                <input type="date" id="nascimento" name="nascimento" class="form-input">
              </section>
            </section>
          </section>
          
          <!-- Endere√ßo -->
          <section class="form-section">
            <h2 class="section-title">Endere√ßo</h2>
            
            <section class="form-row">
              <section class="form-group">
                <label for="cep" class="form-label">CEP *</label>
                <input type="text" id="cep" name="endereco[cep]" class="form-input" required>
              </section>
              
              <section class="form-group">
                <label for="cidade" class="form-label">Cidade *</label>
                <input type="text" id="cidade" name="endereco[cidade]" class="form-input" required>
              </section>
            </section>
            
            <section class="form-row">
              <section class="form-group">
                <label for="endereco" class="form-label">Endere√ßo *</label>
                <input type="text" id="endereco" name="endereco[logradouro]" class="form-input" required>
              </section>
              
              <section class="form-group">
                <label for="numero" class="form-label">N√∫mero *</label>
                <input type="text" id="numero" name="endereco[numero]" class="form-input" required>
              </section>
            </section>
            
            <section class="form-row">
              <section class="form-group">
                <label for="complemento" class="form-label">Complemento</label>
                <input type="text" id="complemento" name="endereco[complemento]" class="form-input">
              </section>
              
              <section class="form-group">
                <label for="estado" class="form-label">Estado *</label>
                <select id="estado" name="endereco[estado]" class="form-input" required>
                  <option value="">Selecione</option>
                  <option value="AC">Acre</option>
                  <option value="AL">Alagoas</option>
                  <option value="AP">Amap√°</option>
                  <option value="AM">Amazonas</option>
                  <option value="BA">Bahia</option>
                  <option value="CE">Cear√°</option>
                  <option value="DF">Distrito Federal</option>
                  <option value="ES">Esp√≠rito Santo</option>
                  <option value="GO">Goi√°s</option>
                  <option value="MA">Maranh√£o</option>
                  <option value="MT">Mato Grosso</option>
                  <option value="MS">Mato Grosso do Sul</option>
                  <option value="MG">Minas Gerais</option>
                  <option value="PA">Par√°</option>
                  <option value="PB">Para√≠ba</option>
                  <option value="PR">Paran√°</option>
                  <option value="PE">Pernambuco</option>
                  <option value="PI">Piau√≠</option>
                  <option value="RJ">Rio de Janeiro</option>
                  <option value="RN">Rio Grande do Norte</option>
                  <option value="RS">Rio Grande do Sul</option>
                  <option value="RO">Rond√¥nia</option>
                  <option value="RR">Roraima</option>
                  <option value="SC">Santa Catarina</option>
                  <option value="SP">S√£o Paulo</option>
                  <option value="SE">Sergipe</option>
                  <option value="TO">Tocantins</option>
                </select>
              </section>
            </section>
          </section>
          
          <!-- M√©todo de Pagamento -->
          <section class="form-section">
            <h2 class="section-title">Forma de Pagamento</h2>
            
            <section class="payment-methods">
              <section class="payment-option">
                <input type="radio" id="cartao" name="metodoPagamento" value="cartao" checked>
                <label for="cartao" class="payment-label">
                  <section class="payment-icon">üí≥</section>
                  <section class="payment-info">
                    <section class="payment-title">Cart√£o de Cr√©dito</section>
                    <section class="payment-desc">Visa, Mastercard, Elo</section>
                  </section>
                </label>
              </section>
              
              <section class="payment-option">
                <input type="radio" id="pix" name="metodoPagamento" value="pix">
                <label for="pix" class="payment-label">
                  <section class="payment-icon">üì±</section>
                  <section class="payment-info">
                    <section class="payment-title">PIX</section>
                    <section class="payment-desc">Pagamento instant√¢neo</section>
                  </section>
                </label>
              </section>
              
              <section class="payment-option">
                <input type="radio" id="boleto" name="metodoPagamento" value="boleto">
                <label for="boleto" class="payment-label">
                  <section class="payment-icon">üßæ</section>
                  <section class="payment-info">
                    <section class="payment-title">Boleto Banc√°rio</section>
                    <section class="payment-desc">Vence em 3 dias √∫teis</section>
                  </section>
                </label>
              </section>
            </section>
          </section>
        </section>
        
        <!-- Resumo do Pedido -->
        <section class="checkout-resumo">
          <section class="resumo-card">
            <h3 class="resumo-title">Resumo do Pedido</h3>
            
            <!-- Itens -->
            <section class="resumo-itens">
              <% carrinho.forEach(function(item) { %>
                <section class="resumo-item">
                  <section class="item-image-mini <%= item.bgClass %>"></section>
                  <section class="item-info-mini">
                    <section class="item-title-mini"><%= item.destino %></section>
                    <section class="item-pessoas"><%= item.quantidade %> <%= item.quantidade === 1 ? 'pessoa' : 'pessoas' %></section>
                  </section>
                  <section class="item-preco-mini">
                    <% 
                      const precoNum = parseFloat(item.preco.replace(/\./g, '').replace(',', '.'));
                      const totalItem = precoNum * item.quantidade;
                    %>
                    R$ <%= totalItem.toLocaleString('pt-BR') %>
                  </section>
                </section>
              <% }); %>
            </section>
            
            <section class="resumo-divider"></section>
            
            <!-- Totais -->
            <section class="resumo-linha">
              <span class="resumo-label">Subtotal:</span>
              <span class="resumo-valor">R$ <%= totais.subtotal.toLocaleString('pt-BR') %></span>
            </section>
            
            <% if (totais.desconto > 0) { %>
              <section class="resumo-linha desconto">
                <span class="resumo-label">Desconto:</span>
                <span class="resumo-valor">- R$ <%= totais.desconto.toLocaleString('pt-BR') %></span>
              </section>
            <% } %>
            
            <section class="resumo-divider"></section>
            
            <section class="resumo-total">
              <span class="total-label">Total:</span>
              <span class="total-valor">R$ <%= totais.total.toLocaleString('pt-BR') %></span>
            </section>
            
            <!-- Bot√µes -->
            <section class="checkout-actions">
              <button type="submit" class="btn-finalizar">
                Finalizar Compra
              </button>
              
              <a href="/carrinho" class="btn-voltar">
                Voltar ao Carrinho
              </a>
            </section>
            
            <!-- Seguran√ßa -->
            <section class="checkout-seguranca">
              <section class="seguranca-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.777 11.777 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24c.304-.143.662-.352 1.048-.625a11.777 11.777 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.541 1.541 0 0 0-1.044-1.263 62.467 62.467 0 0 0-2.887-.87C9.843.266 8.69 0 8 0zm2.146 5.146a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647z"/>
                </svg>
                <span>Pagamento Seguro SSL</span>
              </section>
              
              <section class="seguranca-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/>
                </svg>
                <span>Dados Protegidos</span>
              </section>
            </section>
          </section>
        </section>
      </section>
    </form>
  </section>
</section>

<%- include('../partials/footer') %>
<%- include('../partials/scripts') %>

<script>
// M√°scara para CPF
document.getElementById('cpf').addEventListener('input', function() {
  let value = this.value.replace(/\D/g, '');
  value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
  this.value = value;
});

// M√°scara para telefone
document.getElementById('telefone').addEventListener('input', function() {
  let value = this.value.replace(/\D/g, '');
  if (value.length >= 11) {
    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
  } else {
    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
  }
  this.value = value;
});

// M√°scara para CEP
document.getElementById('cep').addEventListener('input', function() {
  let value = this.value.replace(/\D/g, '');
  value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
  this.value = value;
});

// Consulta CEP
document.getElementById('cep').addEventListener('blur', function() {
  const cep = this.value.replace(/\D/g, '');
  if (cep.length === 8) {
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then(response => response.json())
      .then(data => {
        if (!data.erro) {
          document.getElementById('endereco').value = data.logradouro;
          document.getElementById('cidade').value = data.localidade;
          document.getElementById('estado').value = data.uf;
        }
      })
      .catch(error => console.log('Erro ao consultar CEP:', error));
  }
});

// Sincronizar carrinho na entrada da p√°gina
document.addEventListener('DOMContentLoaded', async function() {
  const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
  console.log('Carrinho no checkout:', carrinho);
  
  if (carrinho.length > 0) {
    try {
      const response = await fetch('/carrinho/sincronizar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ itens: carrinho })
      });
      const data = await response.json();
      console.log('Sincroniza√ß√£o bem-sucedida:', data);
    } catch (error) {
      console.error('Erro ao sincronizar carrinho no checkout:', error);
    }
  } else {
    console.warn('Carrinho vazio no checkout!');
  }
});
</script>
