<%- include('../partials/head', { pageCSS: 'carrinho' }) %>

<%- include('../partials/header', { currentPage: 'checkout' }) %>

<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  window.STRIPE_PUBLIC_KEY = 'pk_test_your_stripe_public_key_here';
</script>

<!-- Hero do Checkout -->
<section class="checkout-hero">
  <section class="container">
    <h1 class="checkout-title inter-font">Finalizar Compra</h1>
    <p class="checkout-subtitle">Complete seus dados e escolha a forma de pagamento</p>
    
    <!-- Progress Steps -->
    <section class="checkout-steps">
      <section class="step completed">
        <section class="step-number">1</section>
        <section class="step-label">Carrinho</section>
      </section>
      <section class="step active">
        <section class="step-number">2</section>
        <section class="step-label">Checkout</section>
      </section>
      <section class="step">
        <section class="step-number">3</section>
        <section class="step-label">Pagamento</section>
      </section>
      <section class="step">
        <section class="step-number">4</section>
        <section class="step-label">Confirma√ß√£o</section>
      </section>
    </section>
  </section>
</section>

<!-- Conte√∫do do Checkout -->
<section class="checkout-content">
  <section class="container">
    <% if (typeof req !== 'undefined' && req.query && req.query.erro) { %>
      <section class="alert alert-warning" style="background: #fef3cd; color: #856404; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; border: 1px solid #ffeaa7;">
        <% if (req.query.erro === 'dados-incompletos') { %>
          ‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios.
        <% } else { %>
          ‚ö†Ô∏è Ocorreu um erro. Tente novamente.
        <% } %>
      </section>
    <% } %>
    
    <% if (typeof req !== 'undefined' && req.query && req.query.adicionado) { %>
      <section class="alert alert-success" style="background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #10b981; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); animation: slideInDown 0.5s ease-out;">
        <section style="display: flex; align-items: center; gap: 0.75rem;">
          <span style="font-size: 1.5rem;">üéâ</span>
          <section>
            <strong style="font-size: 1.1rem;">Destino adicionado com sucesso!</strong><br>
            <span style="font-size: 0.95rem;"><%= req.query.nome || 'Seu destino escolhido' %> est√° pronto para o checkout.</span>
          </section>
        </section>
      </section>
      <style>
        @keyframes slideInDown {
          from {
            opacity: 0;
            transform: translateY(-20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
      </style>
    <% } %>
    
    <!-- Formul√°rio Principal do Checkout -->
    <form id="checkout-form" method="POST" action="/carrinho/checkout" novalidate>
    <section class="checkout-grid">
      <!-- Formul√°rio de Dados -->
      <section class="checkout-dados">
        <!-- Dados do Cliente -->
        <section class="form-section">
          <h2 class="section-title inter-font">Dados do Cliente</h2>
          
          <section class="customer-info">
            <section class="form-group">
              <label for="nome">Nome Completo *</label>
              <input type="text" id="nome" name="nome" required>
            </section>
            
            <section class="form-group">
              <label for="email">E-mail *</label>
              <input type="email" id="email" name="email" required>
            </section>
            
            <section class="form-group">
              <label for="telefone">Telefone *</label>
              <input type="tel" id="telefone" name="telefone" required>
            </section>
            
            <section class="form-group">
              <label for="cpf">CPF/CNPJ *</label>
              <input type="text" id="cpf" name="cpf" required>
            </section>
          </section>
        </section>
        <!-- M√©todos de Pagamento -->
        <section class="form-section">
          <h2 class="section-title inter-font">Escolha o M√©todo de Pagamento</h2>
          <p class="section-subtitle">Selecione uma das op√ß√µes abaixo para finalizar sua compra</p>
          
          <!-- Grid dos m√©todos de pagamento -->
          <section class="payment-methods-grid">
            <!-- Cart√£o de Cr√©dito/D√©bito -->
            <a href="/carrinho/pagamento/cartao" class="payment-method-card">
              <section class="payment-icon">üí≥</section>
              <section class="payment-content">
                <h3 class="payment-title">Cart√£o de Cr√©dito/D√©bito</h3>
                <p class="payment-desc">Pague com seguran√ßa usando seu cart√£o</p>
                <section class="payment-features">
                  <span class="feature">‚úÖ Aprova√ß√£o instant√¢nea</span>
                  <span class="feature">‚úÖ Parcelamento at√© 6x</span>
                  <span class="feature">‚úÖ Todas as bandeiras</span>
                </section>
              </section>
              <section class="payment-arrow">‚Üí</section>
            </a>

            <!-- PIX -->
            <a href="/carrinho/pagamento/pix" class="payment-method-card destaque">
              <section class="payment-icon">üî≤</section>
              <section class="payment-content">
                <h3 class="payment-title">PIX</h3>
                <p class="payment-desc">Pagamento instant√¢neo via PIX</p>
                <section class="payment-features">
                  <span class="feature popular">üî• 2% de desconto</span>
                  <span class="feature">‚úÖ Aprova√ß√£o imediata</span>
                  <span class="feature">‚úÖ Dispon√≠vel 24h</span>
                </section>
              </section>
              <section class="payment-arrow">‚Üí</section>
            </a>

            <!-- Boleto Banc√°rio -->
            <a href="/carrinho/pagamento/boleto" class="payment-method-card">
              <section class="payment-icon">üìÑ</section>
              <section class="payment-content">
                <h3 class="payment-title">Boleto Banc√°rio</h3>
                <p class="payment-desc">Pague em bancos, lot√©ricas ou apps</p>
                <section class="payment-features">
                  <span class="feature">‚úÖ Sem taxas adicionais</span>
                  <span class="feature">‚úÖ Vencimento em 3 dias</span>
                  <span class="feature">‚úÖ Aceito em todo Brasil</span>
                </section>
              </section>
              <section class="payment-arrow">‚Üí</section>
            </a>
          </section>

          <!-- Informa√ß√µes de Seguran√ßa -->
          <section class="payment-security">
            <h4 class="security-title">üîí Seus dados est√£o protegidos</h4>
            <section class="security-features">
              <span class="security-item">üõ°Ô∏è SSL 256-bit</span>
              <span class="security-item">üîê PCI DSS Compliant</span>
              <span class="security-item">‚úÖ Dados criptografados</span>
            </section>
          </section>






        </section>

        <!-- Total do Pedido -->
        <!-- M√©todo de Pagamento Selecionado (Hidden) -->
        <input type="hidden" id="metodoPagamento" name="metodoPagamento" value="cartao">
        
        <section class="form-section">
          <section id="payment-total" class="payment-total">
            <!-- Total ser√° calculado dinamicamente -->
          </section>
        </section>
        </section>
        
        <!-- Resumo do Pedido -->
        <section class="checkout-resumo">
          <section class="resumo-card">
            <h3 class="resumo-title">Resumo do Pedido</h3>
            
            <!-- Itens -->
            <section class="resumo-itens">
              <% carrinho.forEach(function(item) { %>
                <section class="resumo-item">
                  <section class="item-image-mini <%= item.bgClass %>"></section>
                  <section class="item-info-mini">
                    <section class="item-title-mini"><%= item.destino %></section>
                    <section class="item-pessoas"><%= item.quantidade %> <%= item.quantidade === 1 ? 'pessoa' : 'pessoas' %></section>
                  </section>
                  <section class="item-preco-mini">
                    <% 
                      const precoNum = parseFloat(item.preco.replace(/\./g, '').replace(',', '.'));
                      const totalItem = precoNum * item.quantidade;
                    %>
                    R$ <%= totalItem.toLocaleString('pt-BR') %>
                  </section>
                </section>
              <% }); %>
            </section>
            
            <section class="resumo-divider"></section>
            
            <!-- Totais -->
            <section class="resumo-linha">
              <span class="resumo-label">Subtotal:</span>
              <span class="resumo-valor">R$ <%= totais.subtotal.toLocaleString('pt-BR') %></span>
            </section>
            
            <% if (totais.desconto > 0) { %>
              <section class="resumo-linha desconto">
                <span class="resumo-label">Desconto:</span>
                <span class="resumo-valor">- R$ <%= totais.desconto.toLocaleString('pt-BR') %></span>
              </section>
            <% } %>
            
            <section class="resumo-divider"></section>
            
            <section class="resumo-total">
              <span class="total-label">Total:</span>
              <span class="total-valor">R$ <%= totais.total.toLocaleString('pt-BR') %></span>
            </section>
            
            <!-- Bot√µes -->
            <section class="checkout-actions">
              <button type="submit" id="checkout-btn" class="btn-payment">
                Finalizar Compra
              </button>
              
              <a href="/carrinho" class="btn-voltar">
                Voltar ao Carrinho
              </a>
            </section>
            
            <!-- Seguran√ßa -->
            <section class="checkout-seguranca">
              <section class="seguranca-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.777 11.777 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24c.304-.143.662-.352 1.048-.625a11.777 11.777 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.541 1.541 0 0 0-1.044-1.263 62.467 62.467 0 0 0-2.887-.87C9.843.266 8.69 0 8 0zm2.146 5.146a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 7.793l2.646-2.647z"/>
                </svg>
                <span>Pagamento Seguro SSL</span>
              </section>
              
              <section class="seguranca-item">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/>
                </svg>
                <span>Dados Protegidos</span>
              </section>
            </section>
          </section>
        </section>
      </section>
    </section>
  </section>
  </form> <!-- Fim do formul√°rio principal -->
</section>

<!-- Modal de Pagamento -->
<section id="payment-modal" class="payment-modal" style="display: none;">
  <section class="modal-content">
    <h3>Processando Pagamento</h3>
    
    <form id="payment-form">
      <section id="payment-method-details">
        <!-- Detalhes espec√≠ficos do m√©todo de pagamento -->
      </section>
      
      <button type="submit" class="btn-payment" id="confirm-payment-btn">
        Confirmar Pagamento
      </button>
      
      <button type="button" class="btn-secondary" onclick="paymentSystem.hidePaymentModal()">
        Cancelar
      </button>
    </form>
  </section>
</section>

<!-- Loader de Pagamento -->
<section id="payment-loader" class="payment-loader" style="display: none;">
  <section class="spinner"></section>
  <p id="loader-text">Processando...</p>
</section>

<%- include('../partials/footer') %>
<%- include('../partials/scripts') %>

<!-- CSS do Sistema de Pagamento -->
<link rel="stylesheet" href="/css/components/payment.css">

<!-- JavaScript do Sistema de Pagamento -->
<script src="/js/payment.js"></script>

<script>
// M√°scaras e valida√ß√µes para formul√°rios
document.addEventListener('DOMContentLoaded', function() {
  // M√°scara para CPF/CNPJ
  const documentInput = document.getElementById('cpf');
  if (documentInput) {
    documentInput.addEventListener('input', function() {
      this.value = PaymentUtils.formatDocument(this.value);
    });

    documentInput.addEventListener('blur', function() {
      const isValid = PaymentUtils.validateCPF(this.value);
      const formGroup = this.closest('.form-group');
      
      if (isValid) {
        formGroup.classList.remove('error');
        formGroup.classList.add('success');
      } else {
        formGroup.classList.remove('success');
        formGroup.classList.add('error');
      }
    });
  }

  // M√°scara para telefone
  const phoneInput = document.getElementById('telefone');
  if (phoneInput) {
    phoneInput.addEventListener('input', function() {
      this.value = PaymentUtils.formatPhone(this.value);
    });
  }

  // Valida√ß√£o de email
  const emailInput = document.getElementById('email');
  if (emailInput) {
    emailInput.addEventListener('blur', function() {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const formGroup = this.closest('.form-group');
      
      if (emailRegex.test(this.value)) {
        formGroup.classList.remove('error');
        formGroup.classList.add('success');
      } else {
        formGroup.classList.remove('success');
        formGroup.classList.add('error');
      }
    });
  }

  // Valida√ß√£o do formul√°rio principal
  const checkoutForm = document.getElementById('checkout-form');
  if (checkoutForm) {
    checkoutForm.addEventListener('submit', function(e) {
      // Validar campos obrigat√≥rios
      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      
      if (!nome || !email || !telefone || !cpf) {
        e.preventDefault();
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return false;
      }
      
      // Validar email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        e.preventDefault();
        alert('Por favor, digite um email v√°lido.');
        return false;
      }
      
      // Validar CPF
      if (!PaymentUtils.validateCPF(cpf)) {
        e.preventDefault();
        alert('Por favor, digite um CPF v√°lido.');
        return false;
      }
      
      // Se chegou at√© aqui, o form √© v√°lido
      return true;
    });
  }

  // Carregar dados do carrinho e calcular total inicial
  const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
  if (carrinho.length === 0) {
    alert('Seu carrinho est√° vazio!');
    window.location.href = '/carrinho';
    return;
  }

  console.log('Carrinho no checkout:', carrinho);
});

// Fun√ß√£o para sincronizar carrinho com o servidor
async function sincronizarCarrinho() {
  const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
  
  if (carrinho.length > 0) {
    try {
      const response = await fetch('/carrinho/sincronizar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ itens: carrinho })
      });
      const data = await response.json();
      console.log('Sincroniza√ß√£o bem-sucedida:', data);
      return true;
    } catch (error) {
      console.error('Erro ao sincronizar carrinho:', error);
      return false;
    }
  }
  return false;
}

// Sincronizar carrinho quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
  sincronizarCarrinho();
  
  // Auto-remover mensagem de sucesso ap√≥s 5 segundos
  const alertSuccess = document.querySelector('.alert-success');
  if (alertSuccess) {
    setTimeout(() => {
      alertSuccess.style.transition = 'all 0.5s ease-out';
      alertSuccess.style.opacity = '0';
      alertSuccess.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        alertSuccess.remove();
      }, 500);
    }, 5000);
  }
});
</script>
