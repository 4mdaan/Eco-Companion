<%- include('../partials/head', { pageCSS: 'cashback' }) %>

<%- include('../partials/header', { currentPage: 'cashback' }) %>

<!-- Hero do Cashback -->
<section class="cashback-hero">
  <section class="container">
    <section class="hero-content">
      <section class="hero-info">
        <h1 class="hero-title">Programa Eco Cashback</h1>
        <p class="hero-subtitle">Ganhe pontos a cada compra e troque por descontos incr√≠veis!</p>
      </section>
      
      <section class="pontos-card">
        <section class="pontos-header">
          <section class="nivel-badge nivel-<%= usuario.nivelCashback.toLowerCase() %>">
            <span class="nivel-icon">
              <%= usuario.nivelCashback === 'Bronze' ? 'ü•â' : usuario.nivelCashback === 'Silver' ? 'ü•à' : usuario.nivelCashback === 'Gold' ? 'ü•á' : usuario.nivelCashback === 'Platinum' ? 'üíé' : 'üëë' %>
            </span>
            <span class="nivel-texto">N√≠vel <%= usuario.nivelCashback %></span>
          </section>
          <section class="cashback-percentual"><%= usuario.porcentagemCashback %>% de Cashback</section>
        </section>
        
        <section class="pontos-principal">
          <section class="pontos-valor"><%= usuario.pontosTotal.toLocaleString('pt-BR') %></section>
          <section class="pontos-label">pontos dispon√≠veis</section>
        </section>
        
        <% if (usuario.pontosPendentes > 0) { %>
          <section class="pontos-pendentes">
            <span class="pendentes-icon">‚è≥</span>
            <span><%= usuario.pontosPendentes %> pontos pendentes</span>
          </section>
        <% } %>
        
        <section class="progresso-nivel">
          <section class="progresso-header">
            <span>Pr√≥ximo n√≠vel: <%= usuario.proximoNivel || 'M√°ximo alcan√ßado' %></span>
            <% if (usuario.proximoNivel) { %>
              <span><%= usuario.pontosTotal %>/<%= usuario.pontosProximoNivel %></span>
            <% } %>
          </section>
          <% if (usuario.proximoNivel) { %>
            <section class="progresso-barra">
              <section class="progresso-fill" data-width="<%= Math.min(100, (usuario.pontosTotal / usuario.pontosProximoNivel) * 100) %>"></section>
            </section>
          <% } %>
        </section>
      </section>
    </section>
  </section>
</section>

<!-- Dashboard -->
<section class="cashback-dashboard">
  <section class="container">
    <!-- Estat√≠sticas -->
    <section class="stats-grid">
      <section class="stat-card">
        <section class="stat-icon">üí∞</section>
        <section class="stat-info">
          <section class="stat-valor">R$ <%= estatisticas.totalGasto.toLocaleString('pt-BR') %></section>
          <section class="stat-label">Total gasto</section>
        </section>
      </section>
      
      <section class="stat-card">
        <section class="stat-icon">‚≠ê</section>
        <section class="stat-info">
          <section class="stat-valor"><%= estatisticas.pontosGanhos.toLocaleString('pt-BR') %></section>
          <section class="stat-label">Pontos ganhos</section>
        </section>
      </section>
      
      <section class="stat-card">
        <section class="stat-icon">üéÅ</section>
        <section class="stat-info">
          <section class="stat-valor"><%= estatisticas.pontosUsados.toLocaleString('pt-BR') %></section>
          <section class="stat-label">Pontos utilizados</section>
        </section>
      </section>
      
      <section class="stat-card">
        <section class="stat-icon">üöÄ</section>
        <section class="stat-info">
          <section class="stat-valor"><%= usuario.porcentagemCashback %>%</section>
          <section class="stat-label">Taxa atual</section>
        </section>
      </section>
    </section>
    
    <!-- Conte√∫do principal -->
    <section class="dashboard-grid">
      <!-- Recompensas em destaque -->
      <section class="section">
        <section class="section-header">
          <h2 class="section-title">Recompensas em Destaque</h2>
          <a href="/cashback/recompensas" class="ver-todas">Ver todas</a>
        </section>
        
        <section class="recompensas-grid">
          <% recompensasDestaque.forEach(function(recompensa) { %>
            <section class="recompensa-card <%= recompensa.pontosNecessarios <= usuario.pontosTotal ? 'disponivel' : 'indisponivel' %>">
              <section class="recompensa-icon"><%= recompensa.icon %></section>
              <section class="recompensa-info">
                <h3 class="recompensa-titulo"><%= recompensa.titulo %></h3>
                <p class="recompensa-descricao"><%= recompensa.descricao %></p>
                <section class="recompensa-pontos">
                  <span class="pontos-necessarios"><%= recompensa.pontosNecessarios %> pontos</span>
                  <% if (recompensa.pontosNecessarios <= usuario.pontosTotal) { %>
                    <button class="btn-resgatar" data-recompensa-id="<%= recompensa.id %>" data-pontos="<%= recompensa.pontosNecessarios %>">
                      Resgatar
                    </button>
                  <% } else { %>
                    <span class="faltam-pontos">
                      Faltam <%= (recompensa.pontosNecessarios - usuario.pontosTotal).toLocaleString('pt-BR') %> pontos
                    </span>
                  <% } %>
                </section>
              </section>
            </section>
          <% }); %>
        </section>
        
        <% if (recompensasDestaque.length === 0) { %>
          <section class="empty-state">
            <section class="empty-icon">üéØ</section>
            <p>Continue comprando para desbloquear mais recompensas!</p>
          </section>
        <% } %>
      </section>
      
      <!-- Hist√≥rico recente -->
      <section class="section">
        <section class="section-header">
          <h2 class="section-title">Atividade Recente</h2>
          <a href="/cashback/historico" class="ver-todas">Ver hist√≥rico completo</a>
        </section>
        
        <section class="historico-lista">
          <% historicoRecente.forEach(function(transacao) { %>
            <section class="transacao-item">
              <section class="transacao-icon">
                <%= transacao.tipo === 'compra' ? 'üõí' : transacao.tipo === 'resgate' ? 'üéÅ' : '‚≠ê' %>
              </section>
              
              <section class="transacao-info">
                <section class="transacao-titulo"><%= transacao.descricao %></section>
                <section class="transacao-data"><%= transacao.data.toLocaleDateString('pt-BR') %></section>
              </section>
              
              <section class="transacao-pontos">
                <span class="pontos-valor <%= transacao.pontos > 0 ? 'positivos' : 'negativos' %>">
                  <%= transacao.pontos > 0 ? '+' : '' %><%= transacao.pontos %> pts
                </span>
                <% if (transacao.valor > 0) { %>
                  <span class="transacao-valor">R$ <%= transacao.valor.toLocaleString('pt-BR') %></span>
                <% } %>
              </section>
            </section>
          <% }); %>
        </section>
      </section>
    </section>
    
    <!-- Como funciona -->
    <section class="como-funciona">
      <h2 class="section-title">Como Funciona o Eco Cashback</h2>
      
      <section class="funciona-grid">
        <section class="funciona-step">
          <section class="step-numero">1</section>
          <section class="step-content">
            <h3>Fa√ßa suas compras</h3>
            <p>A cada pacote comprado, voc√™ ganha pontos proporcionais ao valor gasto.</p>
          </section>
        </section>
        
        <section class="funciona-step">
          <section class="step-numero">2</section>
          <section class="step-content">
            <h3>Acumule pontos</h3>
            <p>Seus pontos ficam dispon√≠veis imediatamente ap√≥s a confirma√ß√£o da compra.</p>
          </section>
        </section>
        
        <section class="funciona-step">
          <section class="step-numero">3</section>
          <section class="step-content">
            <h3>Troque por recompensas</h3>
            <p>Use seus pontos para resgatar descontos, upgrades e vantagens exclusivas.</p>
          </section>
        </section>
        
        <section class="funciona-step">
          <section class="step-numero">4</section>
          <section class="step-content">
            <h3>Suba de n√≠vel</h3>
            <p>Quanto mais pontos acumular, maior sua taxa de cashback nas pr√≥ximas compras.</p>
          </section>
        </section>
      </section>
    </section>
    
    <!-- N√≠veis do programa -->
    <section class="niveis-programa">
      <h2 class="section-title">N√≠veis do Programa</h2>
      
      <section class="niveis-grid">
        <section class="nivel-card <%= usuario.nivelCashback === 'Bronze' ? 'atual' : '' %>">
          <section class="nivel-header">
            <span class="nivel-icon">ü•â</span>
            <span class="nivel-nome">Bronze</span>
          </section>
          <section class="nivel-cashback">3% de cashback</section>
          <section class="nivel-requisito">0+ pontos</section>
        </section>
        
        <section class="nivel-card <%= usuario.nivelCashback === 'Silver' ? 'atual' : '' %>">
          <section class="nivel-header">
            <span class="nivel-icon">ü•à</span>
            <span class="nivel-nome">Silver</span>
          </section>
          <section class="nivel-cashback">5% de cashback</section>
          <section class="nivel-requisito">1.000+ pontos</section>
        </section>
        
        <section class="nivel-card <%= usuario.nivelCashback === 'Gold' ? 'atual' : '' %>">
          <section class="nivel-header">
            <span class="nivel-icon">ü•á</span>
            <span class="nivel-nome">Gold</span>
          </section>
          <section class="nivel-cashback">8% de cashback</section>
          <section class="nivel-requisito">2.500+ pontos</section>
        </section>
        
        <section class="nivel-card <%= usuario.nivelCashback === 'Platinum' ? 'atual' : '' %>">
          <section class="nivel-header">
            <span class="nivel-icon">üíé</span>
            <span class="nivel-nome">Platinum</span>
          </section>
          <section class="nivel-cashback">12% de cashback</section>
          <section class="nivel-requisito">5.000+ pontos</section>
        </section>
        
        <section class="nivel-card <%= usuario.nivelCashback === 'Diamond' ? 'atual' : '' %>">
          <section class="nivel-header">
            <span class="nivel-icon">üëë</span>
            <span class="nivel-nome">Diamond</span>
          </section>
          <section class="nivel-cashback">15% de cashback</section>
          <section class="nivel-requisito">10.000+ pontos</section>
        </section>
      </section>
    </section>
  </section>
</section>

<%- include('../partials/footer') %>
<%- include('../partials/scripts') %>

<script>
function resgatarRecompensa(id) {
    const btn = event.target;
    const textoOriginal = btn.textContent;
    
    btn.textContent = 'Resgatando...';
    btn.disabled = true;
    
    fetch(`/cashback/resgatar/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.message}\nC√≥digo: ${data.codigoResgate}\nPontos restantes: ${data.pontosRestantes}`);
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao resgatar recompensa');
    })
    .finally(() => {
        btn.textContent = textoOriginal;
        btn.disabled = false;
    });
}

// Configurar largura da barra de progresso
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.progresso-fill');
    progressBars.forEach(bar => {
        const width = bar.getAttribute('data-width');
        if (width) {
            bar.style.width = width + '%';
        }
    });
});
</script>
